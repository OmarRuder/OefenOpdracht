@model IEnumerable<ResultatenSysteem.Models.Resultaat>
@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<ApplicationRole> RoleManager

@{
    double cijfer = 0;
    string display = "hidden";
    string arrowClass = "";
    if (User.IsInRole("Medewerker") == false)
    {
        ViewData["Title"] = "Mijn resultaten";
    }
    else
    {
        ViewData["Title"] = "Resultaten bekijken";
    }
}

<style>
    .rotate {
        -moz-transition: all .1s linear;
        -webkit-transition: all .1s linear;
        transition: all .1s linear;
    }

    .down {
        -moz-transform: rotate(-90deg);
        -webkit-transform: rotate(90deg);
        transform: rotate(-180deg);
    }
</style>

<script>
    $(document).ready(function () {
        $(".toggler").click(function (e) {
            e.preventDefault();
            $('.student-' + $(this).attr('data-student-toggle')).fadeToggle("fast");
            $('.toggle-' + $(this).attr('data-student-toggle')).toggleClass("down");
        });
    });
</script>

<h1>@ViewData["Title"]</h1>
<h3>Welkom @User.Identity.Name</h3>

@if (User.IsInRole("Medewerker"))
{
    <div class="form-group" style="margin:2% 0% 8% 0%;">
        <a class="btn btn-primary" style="float:left;margin-right:20%;color:white;" asp-action="Create">
            Cijfer invoeren
        </a>
        <form asp-controller="Resultaten" asp-action="Index" method="get" style="float:right;margin-right:15%!important" class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
            <div class="input-group" style="color:white;">
                <input type="text" class="form-control bg-light border-0 small" placeholder="Student opzoeken..." name="searchString" aria-label="Search" aria-describedby="basic-addon2">
                <div class="input-group-append">
                    <select class="form-control bg-light border-0 small" name="groepId">
                        <option value="">Alle groepen</option>
                        @foreach (var groep in ViewBag.Groepen)
                        {
                            <option value="@groep.Id">@groep.Naam (@groep.Groepscode)</option>
                        }
                    </select>
                    <input class="btn btn-primary" type="submit" value="Zoeken" />
                    <a class="btn btn-primary" asp-action="Index" asp-route-id="0">
                        <i class="fas fa-sync"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>
}

<table id="studentenTabel" class="table">
    <thead>
        <tr>
            <th>Naam</th>
            <th>Studentnummer</th>
            <th>Resultaten</th>
            <th>Mailen</th>
            <th>Cijfer acties</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var student in ViewBag.Studenten)
        {
            @if (User.IsInRole("Medewerker") == false)
            {
                @if (student.Email == User.Identity.Name)
                {

                    @if (Enumerable.Count(ViewBag.Studenten) <= 1)
                    {
                        display = "normal";
                        arrowClass = "down";
                    }
                    else
                    {
                        display = "none";
                    }
                    <tr>
                        <td style="width:20%;">
                            @student.Voornaam
                            @student.Tussenvoegsel
                            @student.Achternaam
                        </td>
                        <td style="width:20%;">@student.Studentnummer</td>
                        <td style="padding-bottom:2%;margin-bottom:5%;">
                            @if (student.Resultaten != null)
                            {
                                <a href="#" class="toggler" data-student-toggle="@student.Id" style="float:left;">Resultaten bekijken <i class="fas fa-angle-down rotate @arrowClass toggle-@student.Id"></i></a>
                            }
                            else
                            {
                                <span class="text-danger" style="float:left;">Je hebt nog geen resultaten behaald</span>
                            }
                            <br />
                            @foreach (var item in Model.Where(g => g.StudentId == student.Id))
                            {
                                <span class="student-@item.StudentId" id="studentenCijfers" style="display:@display;">
                                    @Html.DisplayFor(modelItem => item.Vak.Vakcode)
                                    @{
                                        cijfer = item.Beoordeling;
                                    }
                                    @if (cijfer < 5.5)
                                    {
                                        <span style="color:red;">
                                            @item.Beoordeling
                                        </span>
                                    }
                                    else
                                    {
                                        <span style="color:forestgreen;">
                                            @item.Beoordeling
                                        </span>
                                    }
                                </span>
                            }
                        </td>
                        <td>
                            <a href="#">@student.Email</a>
                        </td>
                        <td style="width:25%;">
                            <form asp-controller="Resultaten" asp-action="Create" method="get" style="float:left;">
                                <div class="input-group" style="color:white;">
                                    <input name="forStudent" value="@student.Studentnummer-@student.Achternaam" style="display:none;">
                                    <div>
                                        <input class="btn btn-primary" type="submit" value="Invoeren" />
                                    </div>
                                </div>
                            </form>
                            @if (student.Resultaten != null)
                            {
                                <form asp-controller="Resultaten" asp-action="Aanpassen" method="get" style="float:right;margin-right:45%;">
                                    <div class="input-group" style="color:white;">
                                        <input name="studentId" value="@student.Id" style="display:none;">
                                        <div>
                                            <input class="btn btn-primary" type="submit" value="Aanpassen" />
                                        </div>
                                    </div>
                                </form>
                            }
                            else
                            {
                                <span class="btn btn" style="background-color:#859EE7;color:white;float:right;margin-right:45%;cursor:not-allowed;">Aanpassen</span>
                            }

                        </td>
                    </tr>
                }
            }
            else // als user admin is alle studenten laten zien
            {
                @if (Enumerable.Count(ViewBag.Studenten) <= 1)
                {
                    display = "normal";
                    arrowClass = "down";
                }
                else
                {
                    display = "none";
                }
                <tr>
                    <td style="width:20%;">
                        @student.Voornaam
                        @student.Tussenvoegsel
                        @student.Achternaam
                    </td>
                    <td style="width:20%;">@student.Studentnummer</td>
                    <td style="padding-bottom:2%;margin-bottom:5%;">
                        @if (student.Resultaten != null)
                        {
                            <a href="#" class="toggler" data-student-toggle="@student.Id" style="float:left;">Resultaten bekijken <i class="fas fa-angle-down rotate @arrowClass toggle-@student.Id"></i></a>
                        }
                        else
                        {
                            <span class="text-danger" style="float:left;">Deze student heeft nog geen cijfers</span>
                        }
                        <br />
                        @foreach (var item in Model.Where(g => g.StudentId == student.Id))
                        {
                            <span class="student-@item.StudentId" id="studentenCijfers" style="display:@display;">
                                @Html.DisplayFor(modelItem => item.Vak.Vakcode)
                                @{
                                    cijfer = item.Beoordeling;
                                }
                                @if (cijfer < 5.5)
                                {
                                    <span style="color:red;">
                                        @item.Beoordeling
                                    </span>
                                }
                                else
                                {
                                    <span style="color:forestgreen;">
                                        @item.Beoordeling
                                    </span>
                                }
                            </span>
                        }
                    </td>
                    <td>
                        <a href="#">@student.Email</a>
                    </td>
                    <td style="width:25%;">
                        <form asp-controller="Resultaten" asp-action="Create" method="get" style="float:left;">
                            <div class="input-group" style="color:white;">
                                <input name="forStudent" value="@student.Studentnummer-@student.Achternaam" style="display:none;">
                                <div>
                                    <input class="btn btn-primary" type="submit" value="Invoeren" />
                                </div>
                            </div>
                        </form>
                        @if (student.Resultaten != null)
                        {
                            <form asp-controller="Resultaten" asp-action="Aanpassen" method="get" style="float:right;margin-right:45%;">
                                <div class="input-group" style="color:white;">
                                    <input name="studentId" value="@student.Id" style="display:none;">
                                    <div>
                                        <input class="btn btn-primary" type="submit" value="Aanpassen" />
                                    </div>
                                </div>
                            </form>
                        }
                        else
                        {
                            <span class="btn btn" style="background-color:#859EE7;color:white;float:right;margin-right:45%;cursor:not-allowed;">Aanpassen</span>
                        }

                    </td>
                </tr>
            }
        }
    </tbody>
</table>